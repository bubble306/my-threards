<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Echo's Threads - 正式版</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        button { background: #000; color: #fff; border: none; padding: 12px; border-radius: 25px; cursor: pointer; width: 100%; font-weight: bold; }
        .post { background: white; padding: 15px; border-radius: 15px; margin-top: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-tag { color: #1d9bf0; font-weight: bold; }
        .post-content { margin: 10px 0; font-size: 16px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 10px; margin: 10px 0; display: block; }
        .actions { display: flex; gap: 20px; border-top: 1px solid #f0f0f0; padding-top: 10px; color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="box">
        <input type="text" id="nickname" placeholder="你的名字">
        <textarea id="t" rows="3" placeholder="写点什么..."></textarea>
        <input type="file" id="fileInput" accept="image/*">
        <button id="sendBtn" onclick="send()">发布动态</button>
    </div>
    <div id="list" style="width: 100%; max-width: 450px;">正在加载内容...</div>

    <script>
        const SB_URL = "https://fzxucsdptrikazqvdnlv.supabase.co";
        // 已经帮你贴好了你给我的那个 Key
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eHVjc2RwdHJpa2F6cXZkbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzU0NjYsImV4cCI6MjA4NTkxMTQ2Nn0.ZChcBRbRorV7pHrQmGd0MV_A2x4fz8_h55-lMqvHhNY"; 
        const client = supabase.createClient(SB_URL, SB_KEY);

        async function load() {
            const { data: posts, error } = await client.from('posts').select('*').order('created_at', { ascending: false });
            if (error) return;
            const list = document.getElementById('list');
            list.innerHTML = "";
            for (let p of posts) {
                const d = document.createElement('div');
                d.className = 'post';
                // 重点：如果 image_url 有值，才显示图片标签
                let imgHtml = p.image_url ? `< img src="${p.image_url}" class="post-img">` : '';
                d.innerHTML = `
                    <div class="user-tag">@${p.user_name || '匿名'}</div>
                    <div class="post-content">${p.content || ''}</div>
                    ${imgHtml}
                    <div class="actions">❤️ ${p.likes || 0}</div>
                `;
                list.appendChild(d);
            }
        }

        async function send() {
            const btn = document.getElementById('sendBtn');
            const name = document.getElementById('nickname').value || '匿名';
            const val = document.getElementById('t').value;
            const file = document.getElementById('fileInput').files[0];
            let finalUrl = null;

            if (!val && !file) return;
            btn.innerText = "上传中...";
            btn.disabled = true;

            if (file) {
                const fileName = Date.now() + '-' + file.name;
                const { data, error } = await client.storage.from('images').upload(fileName, file);
                if (!error) {
                    const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(fileName);
                    finalUrl = publicUrl;
                }
            }

            // 重点：存入数据库时，不要自己拼 <img> 标签！直接存 finalUrl
            await client.from('posts').insert([{ content: val, user_name: name, likes: 0, image_url: finalUrl }]);
            
            btn.innerText = "发布动态";
            btn.disabled = false;
            document.getElementById('t').value = "";
            document.getElementById('fileInput').value = "";
            load();
        }
        load();
    </script>
</body>
</html>










