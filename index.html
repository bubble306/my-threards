<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Echo's Threads</title>
    <script>
        document.write('<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2?v=' + Math.random() + '"><\/script>');
    </script>
    <style>
        :root { 
            --primary: #000000; --bg: #ffffff; --secondary-bg: #f2f2f7;
            --text: #000000; --gray: #8e8e93; --border: #e5e5ea; --accent: #1d9bf0;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px;
            overflow-x: hidden;
        }

        header {
            height: 60px; display: flex; align-items: center; justify-content: center;
            position: sticky; top: 0; background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px); z-index: 100; border-bottom: 0.5px solid var(--border);
        }
        .logo { font-size: 22px; font-weight: 800; letter-spacing: -1px; }

        .app-container { max-width: 600px; margin: 0 auto; padding: 0 10px; }

        .post { 
            padding: 16px 0; border-bottom: 0.5px solid var(--border); 
            display: flex; gap: 12px; animation: fadeIn 0.4s ease;
        }
        .avatar-circle {
            width: 40px; height: 40px; background: var(--secondary-bg);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: var(--gray); font-size: 14px; flex-shrink: 0;
        }
        .post-main { flex: 1; }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .user-name { font-weight: 700; font-size: 15px; cursor: pointer; }
        .post-content { font-size: 15px; line-height: 1.4; margin-bottom: 12px; white-space: pre-wrap; word-break: break-all; }
        
        .post-actions { display: flex; gap: 20px; margin-bottom: 10px; }
        .action-btn { 
            background: none; border: none; padding: 0; display: flex; align-items: center; 
            gap: 5px; color: var(--text); cursor: pointer; font-size: 13px; font-weight: 500;
        }
        .action-btn svg { width: 20px; height: 20px; stroke-width: 2; }

        .comment-section { background: var(--secondary-bg); border-radius: 12px; padding: 10px; margin-top: 8px; }
        .comment-item { font-size: 13px; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
        .comment-item b { color: var(--accent); margin-right: 4px; }
        .reply-input-wrap { display: flex; gap: 8px; margin-top: 8px; }
        .reply-input { 
            flex: 1; border: none; background: #fff; padding: 8px 12px; 
            border-radius: 20px; font-size: 13px; outline: none; border: 0.5px solid var(--border);
        }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 0.5px solid var(--border); display: flex; justify-content: space-around;
            align-items: center; z-index: 200;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--gray); cursor: pointer; font-size: 10px; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 26px; height: 26px; }

        #compose-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 300; display: none; padding: 20px;
            animation: slideUp 0.3s ease;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { font-size: 16px; color: var(--gray); cursor: pointer; }
        .post-btn { background: var(--primary); color: #fff; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; }
        #post-textarea { width: 100%; height: 200px; border: none; outline: none; font-size: 18px; resize: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .profile-header { padding: 30px 0; text-align: center; border-bottom: 8px solid var(--secondary-bg); display: none; }
    </style>
</head>
<body>

<header><div class="logo">Echo's Threads</div></header>

<div class="app-container">
    <div id="profile-view" class="profile-header">
        <div class="avatar-circle" style="width: 80px; height: 80px; margin: 0 auto 15px; font-size: 30px;">E</div>
        <h2 id="p-name" style="margin:0">用户主页</h2>
        <p style="color:var(--gray); font-size:14px;">已发布的内容</p >
    </div>
    
    <div id="main-feed" style="text-align: center; padding: 50px; color: var(--gray);">正在同步数据...</div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="showHome()">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L3 9v11a2 2 0 002 2h14a2 2 0 002-2V9l-9-7zm7 18h-4v-7H9v7H5V10l7-5.45L19 10v10z"/></svg>
        <span>首页</span>
    </div>
    <div class="nav-item" onclick="openCompose()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 4v16m8-8H4"/></svg>
        <span>发布</span>
    </div>
    <div class="nav-item" id="nav-profile" onclick="showProfile()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        <span>我的</span>
    </div>
</div>

<div id="compose-modal">
    <div class="modal-header">
        <span class="close-btn" onclick="closeCompose()">取消</span>
        <button class="post-btn" onclick="sendPost()">发布</button>
    </div>
    <input type="text" id="nickname" placeholder="你的昵称" class="reply-input" style="margin-bottom: 15px; width: 100%; height: 40px; border: 1px solid var(--border);">
    <textarea id="post-textarea" placeholder="发生了什么新鲜事？"></textarea>
</div>

<script>
    // 自动清洗 Key 中的非法字符
    const RAW_URL = 'https://fzxucsdptrikazqvdnlv.supabase.co';
    const RAW_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eHVjc2RwdHJpa2F6cXZkbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzU0NjYsImV4cCI6MjA4NTkxMTQ2Nn0.ZChcBRbRorV7pHrQmGd0MV_A2x4fz8_h55-lMqvHhNY'; 
    
    const SUPABASE_URL = RAW_URL.trim();
    const SUPABASE_KEY = RAW_KEY.replace(/[^\x00-\x7F]/g, "").trim(); 

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = () => {
        const savedName = localStorage.getItem('echo_nickname');
        if (savedName) document.getElementById('nickname').value = savedName;
        loadFeed();
    };

    async function loadFeed(user = null) {
        const feed = document.getElementById('main-feed');
        // 只选核心字段，避开 image_url 报错
        let query = client.from('posts').select('id, user_name, content, likes, comments(*)').order('id', { ascending: false });
        
        if (user) {
            query = query.eq('user_name', user);
            document.getElementById('profile-view').style.display = 'block';
            document.getElementById('p-name').innerText = "@" + user;
        } else {
            document.getElementById('profile-view').style.display = 'none';
        }

        const { data, error } = await query;
        if (error) {
            feed.innerHTML = `<div style="padding:20px; color:red;">同步失败: ${error.message}</div>`;
            return;
        }

        feed.innerHTML = data.map(p => {
            // 防崩溃处理：强行将 HTML 标签转义为纯文本
            const safeContent = String(p.content || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            return `
                <div class="post" id="post-${p.id}">
                    <div class="avatar-circle">${p.user_name ? p.user_name[0].toUpperCase() : 'E'}</div>
                    <div class="post-main">
                        <div class="post-header">
                            <span class="user-name" onclick="loadFeed('${p.user_name}')">@${p.user_name || '匿名'}</span>
                            <span style="color:var(--gray); font-size:12px;">最新</span>
                        </div>
                        <div class="post-content">${safeContent}</div>
                        <div class="post-actions">
                            <button class="action-btn" onclick="likePost(${p.id}, this)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                                <span class="like-count">${p.likes || 0}</span>
                            </button>
                            <button class="action-btn">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                <span>${p.comments ? p.comments.length : 0}</span>
                            </button>
                        </div>
                        <div class="comment-section">
                            <div id="cmt-list-${p.id}">
                                ${(p.comments || []).map(c => `
                                    <div class="comment-item"><b>${c.user_name}:</b> ${String(c.content).replace(/</g, "&lt;")}</div>
                                `).join('')}
                            </div>
                            <div class="reply-input-wrap">
                                <input type="text" class="reply-input" placeholder="写回复..." 
                                       onkeypress="if(event.key==='Enter') addComment(${p.id}, this)">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('') || '<div style="text-align:center; padding:50px; color:gray;">暂无动态，发第一条吧！</div>';
    }

    async function sendPost() {
        const txt = document.getElementById('post-textarea');
        const nick = document.getElementById('nickname').value || '匿名';
        if (!txt.value.trim()) return;

        localStorage.setItem('echo_nickname', nick);
        // 发布时确保不传 image_url 字段
        const { error } = await client.from('posts').insert([{ content: txt.value, user_name: nick, likes: 0 }]);
        
        if (!error) {
            txt.value = "";
            closeCompose();
            loadFeed();
        } else {
            alert("发布失败: " + error.message);
        }
    }

    async function likePost(id, el) {
        const span = el.querySelector('.like-count');
        let count = parseInt(span.innerText);
        span.innerText = count + 1;
        el.style.color = '#ff3b30';
        await client.from('posts').update({ likes: count + 1 }).eq('id', id);
    }

    async function addComment(postId, input) {
        const nick = document.getElementById('nickname').value || '匿名';
        const text = input.value;
        if (!text.trim()) return;

        const cmtList = document.getElementById(`cmt-list-${postId}`);
        cmtList.insertAdjacentHTML('beforeend', `<div class="comment-item"><b>${nick}:</b> ${text}</div>`);
        input.value = "";
        await client.from('comments').insert([{ post_id: postId, content: text, user_name: nick }]);
    }

    function openCompose() { document.getElementById('compose-modal').style.display = 'block'; }
    function closeCompose() { document.getElementById('compose-modal').style.display = 'none'; }
    function showHome() { 
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-home').classList.add('active');
        loadFeed(); 
    }
    function showProfile() { 
        const name = document.getElementById('nickname').value || '匿名';
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-profile').classList.add('active');
        loadFeed(name); 
    }
</script>
</body>
</html>


















