<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Echo's Threads - ç»ˆæä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        button { background: #000; color: #fff; border: none; padding: 12px; border-radius: 25px; cursor: pointer; width: 100%; font-weight: bold; }
        button:disabled { background: #ccc; }
        .post { background: white; padding: 15px; border-radius: 15px; margin-top: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-tag { color: #1d9bf0; font-weight: bold; }
        .post-content { margin: 10px 0; font-size: 16px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 10px; margin: 10px 0; display: block; }
        .actions { display: flex; gap: 20px; border-top: 1px solid #f0f0f0; padding-top: 10px; color: #666; font-size: 14px; }
        .action-item { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .comment-section { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 13px; }
        .cmt-item { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
    </style>
</head>
<body>
    <div class="box">
        <input type="text" id="nickname" placeholder="ä½ çš„åå­—">
        <textarea id="t" rows="3" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
        <input type="file" id="fileInput" accept="image/*">
        <button id="sendBtn" onclick="send()">å‘å¸ƒåŠ¨æ€</button>
    </div>
    <div id="list" style="width: 100%; max-width: 450px;">æ­£åœ¨åŠ è½½å†…å®¹...</div>

    <script>
        // å·²ç»å¸®ä½ å¡«å¥½äº†å¯¹åº”çš„ URL å’Œ Key
        const SB_URL = "https://fzxucsdptrikazqvdnlv.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eHVjc2RwdHJpa2F6cXZkbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzU0NjYsImV4cCI6MjA4NTkxMTQ2Nn0.ZChcBRbRorV7pHrQmGd0MV_A2x4fz8_h55-lMqvHhNY"; 
        const client = supabase.createClient(SB_URL, SB_KEY);

        async function load() {
            // è·å–å¸–å­åˆ—è¡¨
            const { data: posts, error } = await client.from('posts').select('*').order('created_at', { ascending: false });
            
            if (error) {
                document.getElementById('list').innerHTML = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æ˜¯å¦è¿‡æœŸã€‚é”™è¯¯ä¿¡æ¯ï¼š" + error.message;
                return;
            }

            const list = document.getElementById('list');
            list.innerHTML = "";
            
            if (posts.length === 0) {
                list.innerHTML = "æš‚æ— åŠ¨æ€ï¼Œå¿«å»å‘ä¸€æ¡å§ï¼";
            }

            for (let p of posts) {
                // è·å–æ¯ä¸ªå¸–å­çš„è¯„è®º
                const { data: cms } = await client.from('comments').select('*').eq('post_id', p.id);
                const d = document.createElement('div');
                d.className = 'post';
                
                // æ ¸å¿ƒä¿®å¤ç‚¹ï¼šæ­£ç¡®å¤„ç†å›¾ç‰‡æ˜¾ç¤º
                let imageElement = "";
                if (p.image_url && p.image_url.startsWith('http')) {
                    imageElement = `< img src="${p.image_url}" class="post-img">`;
                }

                d.innerHTML = `
                    <div class="user-tag">@${p.user_name || 'åŒ¿å'}</div>
                    <div class="post-content">${p.content || ''}</div>
                    ${imageElement}
                    <div class="actions">
                        <div class="action-item" onclick="like(${p.id}, ${p.likes || 0})">â¤ï¸ ${p.likes || 0}</div>
                        <div class="action-item">ğŸ’¬ ${cms ? cms.length : 0}</div>
                    </div>
                    <div class="comment-section">
                        <div id="cmt-list-${p.id}">${cms ? cms.map(c => `<div class="cmt-item"><b>${c.user_name}:</b> ${c.content}</div>`).join('') : ''}</div>
                        <input type="text" placeholder="å†™è¯„è®ºå¹¶å›è½¦..." onkeydown="if(event.keyCode==13) addComment(${p.id}, this)">
                    </div>
                `;
                list.appendChild(d);
            }
        }

        async function send() {
            const btn = document.getElementById('sendBtn');
            const name = document.getElementById('nickname').value || 'åŒ¿å';
            const val = document.getElementById('t').value;
            const file = document.getElementById('fileInput').files[0];
            let urlToSave = null;

            if (!val && !file) return;
            btn.innerText = "æ­£åœ¨å‘å¸ƒ...";
            btn.disabled = true;

            try {
                // 1. ä¸Šä¼ å›¾ç‰‡åˆ° Storage
                if (file) {
                    const fileName = Date.now() + '-' + file.name;
                    const { data, error: uploadError } = await client.storage.from('images').upload(fileName, file);
                    
                    if (uploadError) {
                        alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š" + uploadError.message);
                    } else {
                        // 2. è·å–å…¬å¼€é“¾æ¥
                        const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(fileName);
                        urlToSave = publicUrl;
                    }
                }

                // 3. å­˜å…¥æ•°æ®åº“è¡¨
                const { error: dbError } = await client.from('posts').insert([{ 
                    content: val, 
                    user_name: name, 
                    likes: 0, 
                    image_url: urlToSave 
                }]);

                if (dbError) throw dbError;

                // å‘å¸ƒæˆåŠŸåé‡ç½®é¡µé¢
                document.getElementById('t').value = "";
                document.getElementById('fileInput').value = "";
                load();
            } catch (err) {
                alert("å‘å¸ƒå¤±è´¥ï¼š" + err.message);
            } finally {
                btn.innerText = "å‘å¸ƒåŠ¨æ€";
                btn.disabled = false;
            }
        }

        async function like(id, curr) {
            await client.from('posts').update({ likes: curr + 1 }).eq('id', id);
            load();
        }

        async function addComment(postId, input) {
            const name = document.getElementById('nickname').value || 'åŒ¿å';
            if(!input.value) return;
            await client.from('comments').insert([{ post_id: postId, content: input.value, user_name: name }]);
            input.value = "";
            load();
        }

        load();
    </script>
</body>
</html>









