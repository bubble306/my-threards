<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Project | bubble306</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 500px; margin: auto; background: #f7f7f7; padding: 10px; }
        .input-area { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        textarea { width: 100%; height: 100px; border: none; outline: none; resize: none; font-size: 16px; margin-bottom: 10px; }
        #sendBtn { background: #07c160; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; }
        #sendBtn:disabled { background: #9ed9ba; }
        .post { background: white; padding: 15px; margin-bottom: 10px; border-radius: 12px; }
        .user-name { font-weight: bold; color: #576b95; margin-bottom: 8px; }
        .post-img { width: 100%; border-radius: 8px; margin: 10px 0; display: block; }
        .post-time { font-size: 12px; color: #b1b1b1; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="input-area">
        <input type="text" id="nickname" placeholder="昵称" style="width:100%; border:none; border-bottom:1px solid #eee; margin-bottom:10px; padding:5px 0;">
        <textarea id="t" placeholder="这一刻的想法..."></textarea>
        <input type="file" id="fileInput" accept="image/*">
        <button id="sendBtn" onclick="send()">发表</button>
    </div>

    <div id="list"></div>

    <script>
        // 这里我已经帮你保留了你之前的连接配置逻辑
        const SUPABASE_URL = 'https://ovggmclsqmivmrrvlbpa.supabase.co'; 
        const SUPABASE_KEY = 'YOUR_SUPABASE_KEY'; // 这里如果我没有你最新的KEY，请确保此处是你原本代码里的那一串
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function load() {
            const { data, error } = await client.from('posts').select('*, comments(*)').order('id', { ascending: false });
            if (error) return;
            const list = document.getElementById('list');
            list.innerHTML = data.map(p => `
                <div class="post">
                    <div class="user-name">${p.user_name || '匿名'}</div>
                    <div style="white-space: pre-wrap;">${p.content || ''}</div>
                    
                    ${p.image_url ? `< img src="${p.image_url}" class="post-img" onerror="this.style.display='none'">` : ''}
                    
                    <div class="post-time">${new Date(p.created_at).toLocaleString()}</div>
                    <div style="margin-top:10px;">
                        <button onclick="like(${p.id}, ${p.likes})" style="border:none; background:none; color:#576b95;">❤️ ${p.likes || 0}</button>
                    </div>
                </div>
            `).join('');
        }

        async function send() {
            const btn = document.getElementById('sendBtn');
            const name = document.getElementById('nickname').value || '匿名';
            const val = document.getElementById('t').value;
            const file = document.getElementById('fileInput').files[0];
            let imageUrl = null;

            if (!val && !file) return;
            btn.innerText = "上传中...";
            btn.disabled = true;

            try {
                if (file) {
                    const fileName = Date.now() + '-' + file.name;
                    const { data, error } = await client.storage.from('images').upload(fileName, file);
                    if (error) throw error;
                    const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(fileName);
                    imageUrl = publicUrl;
                }

                await client.from('posts').insert([{ 
                    content: val, 
                    user_name: name, 
                    likes: 0, 
                    image_url: imageUrl  // 确保这里和你数据库列名一致
                }]);

                document.getElementById('t').value = "";
                document.getElementById('fileInput').value = "";
                load();
            } catch (err) {
                alert("发布失败，请检查数据库 image_url 列名是否正确");
            } finally {
                btn.innerText = "发表";
                btn.disabled = false;
            }
        }

        async function like(id, curr) {
            await client.from('posts').update({ likes: (curr || 0) + 1 }).eq('id', id);
            load();
        }

        load();
    </script>
</body>
</html>












