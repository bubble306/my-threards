<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo's Threads</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #1d9bf0; --bg: #ffffff; --secondary-bg: #f7f9f9;
            --text: #0f1419; --gray: #536471; --border: #eff3f4;
        }
        
        * { transition: background 0.2s, transform 0.1s; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* å¯¼èˆª */
        nav { 
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); 
            padding: 15px; position: sticky; top: 0; z-index: 100; 
            border-bottom: 1px solid var(--border); text-align: center; 
            font-weight: 800; font-size: 20px; cursor: pointer;
        }

        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        
        /* å‘å¸ƒåŒº */
        .input-box { padding: 20px; border-bottom: 8px solid var(--border); }
        textarea { 
            width: 100%; border: none; font-size: 19px; outline: none; resize: none; 
            min-height: 100px; line-height: 1.4;
        }
        .input-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .input-field { 
            background: var(--secondary-bg); border: 1px solid transparent; padding: 8px 16px; 
            border-radius: 99px; outline: none; width: 130px; font-size: 14px;
        }
        #sendBtn { 
            background: var(--primary); color: white; border: none; padding: 10px 25px; 
            border-radius: 99px; font-weight: bold; cursor: pointer;
        }
        #sendBtn:active { transform: scale(0.95); }

        /* å¸–å­å¡ç‰‡ */
        .post { padding: 16px; border-bottom: 1px solid var(--border); animation: slideIn 0.3s ease-out; }
        .nickname { font-weight: 700; color: var(--text); cursor: pointer; margin-bottom: 5px; display: inline-block; }
        .nickname:hover { text-decoration: underline; }
        .content { font-size: 16px; line-height: 1.5; white-space: pre-wrap; margin: 8px 0; }
        
        /* äº¤äº’æŒ‰é’® */
        .actions { display: flex; gap: 30px; color: var(--gray); font-size: 14px; margin: 12px 0; }
        .action-item { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 99px; }
        .action-item:hover { background: rgba(29, 155, 240, 0.1); color: var(--primary); }

        /* è¯„è®ºåŒºï¼šæ›´æµç•…çš„å±‚çº§ */
        .comments-area { 
            margin-top: 10px; padding: 12px; background: var(--secondary-bg); 
            border-radius: 12px; font-size: 14px; 
        }
        .cmt-list { margin-bottom: 10px; }
        .cmt-item { padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.03); animation: fadeIn 0.3s; }
        .cmt-user { font-weight: 700; margin-right: 5px; color: var(--primary); }
        .cmt-input { 
            width: 100%; border: none; background: #fff; outline: none; 
            padding: 8px 12px; border-radius: 20px; border: 1px solid var(--border);
        }

        /* åŠ¨ç”» */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ä¸ªäººé¡µ */
        .profile-head { padding: 30px 20px; text-align: center; border-bottom: 8px solid var(--border); display: none; }
    </style>
</head>
<body>

<nav onclick="showHome()">Echo's Threads</nav>

<div class="container">
    <div id="profile-head" class="profile-head">
        <div style="color: var(--primary); cursor: pointer; margin-bottom: 10px;" onclick="showHome()">â† è¿”å›å…¨ç«™</div>
        <h2 id="p-name" style="margin:0"></h2>
    </div>

    <div id="publish-area" class="input-box">
        <textarea id="t" placeholder="å‘ç”Ÿäº†ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ"></textarea>
        <div class="input-footer">
            <input type="text" id="nickname" class="input-field" placeholder="æ˜µç§°">
            <button id="sendBtn" onclick="send()">å‘å¸ƒ</button>
        </div>
    </div>

    <div id="list">æ­£åœ¨è¿æ¥ Echo çš„ç©ºé—´...</div>
</div>

<script>
    // è‡ªåŠ¨é…ç½®é¡¹ç›®åœ°å€
    const SUPABASE_URL = 'https://fzxucsdptrikazqvdnlv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eHVjc2RwdHJpa2F6cXZkbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzU0NjYsImV4cCI6MjA4NTkxMTQ2Nn0.ZChcBRbRorV7pHrQmGd0MV_A2x4fz8_h55-lMqvHhNY'; 
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentViewUser = null;

    // æ ¸å¿ƒæ¸²æŸ“é€»è¾‘
    async function load(user = null) {
        currentViewUser = user;
        let query = client.from('posts').select('*, comments(*)').order('id', { ascending: false });
        
        if (user) {
            query = query.eq('user_name', user);
            document.getElementById('publish-area').style.display = 'none';
            document.getElementById('profile-head').style.display = 'block';
            document.getElementById('p-name').innerText = "@" + user;
        } else {
            document.getElementById('publish-area').style.display = 'block';
            document.getElementById('profile-head').style.display = 'none';
        }

        const { data, error } = await query;
        if (error) return;

        document.getElementById('list').innerHTML = data.map(p => renderPost(p)).join('');
    }

    // æå–å•ä¸ªå¸–å­ HTML
    function renderPost(p) {
        return `
            <div class="post" id="post-${p.id}">
                <span class="nickname" onclick="load('${p.user_name}')">@${p.user_name || 'åŒ¿å'}</span>
                <div class="content">${p.content}</div>
                <div class="actions">
                    <div class="action-item" onclick="like(${p.id}, this)">
                        <span>â¤ï¸</span> <b class="like-count">${p.likes || 0}</b>
                    </div>
                    <div class="action-item">
                        <span>ğŸ’¬</span> <b>${(p.comments || []).length}</b>
                    </div>
                </div>
                <div class="comments-area">
                    <div class="cmt-list" id="cmt-list-${p.id}">
                        ${(p.comments || []).map(c => `<div class="cmt-item"><span class="cmt-user">${c.user_name}:</span>${c.content}</div>`).join('')}
                    </div>
                    <input type="text" class="cmt-input" placeholder="å‘å¸ƒä½ çš„å›å¤..." 
                           onkeypress="if(event.key==='Enter') addComment(${p.id}, this)">
                </div>
            </div>
        `;
    }

    // å‘å¸ƒåŠ¨æ€ï¼šå‘å¸ƒåç›´æ¥æ’å…¥é¡¶éƒ¨
    async function send() {
        const t = document.getElementById('t');
        const nameInput = document.getElementById('nickname');
        const name = nameInput.value || 'åŒ¿å';
        if (!t.value) return;

        const { data, error } = await client.from('posts').insert([{ 
            content: t.value, user_name: name, likes: 0 
        }]).select();

        if (!error && data) {
            t.value = "";
            const list = document.getElementById('list');
            list.insertAdjacentHTML('afterbegin', renderPost({...data[0], comments: []}));
        }
    }

    // ç¬æ—¶ç‚¹èµï¼šå…ˆå˜æ•°å­—ï¼Œå†æ”¹æ•°æ®åº“
    async function like(id, el) {
        const countEl = el.querySelector('.like-count');
        let currentLikes = parseInt(countEl.innerText);
        countEl.innerText = currentLikes + 1; // è§†è§‰ç¬æ—¶åé¦ˆ
        el.style.color = 'var(--primary)';
        
        await client.from('posts').update({ likes: currentLikes + 1 }).eq('id', id);
    }

    // ç¬æ—¶è¯„è®ºï¼šç›´æ¥æ’å…¥è¯„è®ºåˆ—è¡¨ï¼Œä¸åˆ·å…¨é¡µ
    async function addComment(postId, input) {
        const name = document.getElementById('nickname').value || 'åŒ¿å';
        const text = input.value;
        if (!text) return;

        // 1. å…ˆåœ¨å‰ç«¯æ˜¾ç¤ºï¼ˆç¬æ—¶æ„Ÿï¼‰
        const cmtList = document.getElementById(`cmt-list-${postId}`);
        const newCmtHtml = `<div class="cmt-item"><span class="cmt-user">${name}:</span>${text}</div>`;
        cmtList.insertAdjacentHTML('beforeend', newCmtHtml);
        input.value = "";

        // 2. åå°åŒæ­¥åˆ°æ•°æ®åº“
        await client.from('comments').insert([{ 
            post_id: postId, content: text, user_name: name 
        }]);
    }

    function showHome() { load(); }
    load();
</script>
</body>
</html>














