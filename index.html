<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Echo's Threads - å…¨åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        button { background: #000; color: #fff; border: none; padding: 12px; border-radius: 25px; cursor: pointer; width: 100%; font-weight: bold; }
        .post { background: white; padding: 15px; border-radius: 15px; margin-top: 15px; width: 100%; max-width: 450px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-tag { color: #1d9bf0; font-weight: bold; }
        .post-content { margin: 10px 0; font-size: 16px; white-space: pre-wrap; }
        .actions { display: flex; gap: 20px; border-top: 1px solid #f0f0f0; padding-top: 10px; color: #666; font-size: 14px; }
        .action-item { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .comment-section { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 13px; }
        .cmt-item { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        img.post-img { width: 100%; border-radius: 10px; margin: 10px 0; display: block; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="box">
        <input type="text" id="nickname" placeholder="ä½ çš„åå­—">
        <textarea id="t" rows="3" placeholder="è¯´ç‚¹ä»€ä¹ˆï¼Œæˆ–è€…ä¸Šä¼ ä¸€å¼ å›¾ç‰‡..."></textarea>
        <input type="file" id="fileInput" accept="image/*">
        <button id="sendBtn" onclick="send()">å‘å¸ƒåŠ¨æ€</button>
    </div>
    <div id="list" style="width: 100%; max-width: 450px;">æ­£åœ¨åŠ è½½...</div>

    <script>
        const SB_URL = "https://fzxucsdptrikazqvdnlv.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eHVjc2RwdHJpa2F6cXZkbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzU0NjYsImV4cCI6MjA4NTkxMTQ2Nn0.ZChcBRbRorV7pHrQmGd0MV_A2x4fz8_h55-lMqvHhNY"; 
        const client = supabase.createClient(SB_URL, SB_KEY);

        async function load() {
            const { data: posts, error } = await client.from('posts').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);
            const list = document.getElementById('list');
            list.innerHTML = "";
            
            for (let p of posts) {
                const { data: cms } = await client.from('comments').select('*').eq('post_id', p.id);
                const d = document.createElement('div');
                d.className = 'post';
                
                // å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ï¼šå¦‚æœæœ‰ image_url å°±æ˜¾ç¤ºå›¾ç‰‡
                const imgHtml = p.image_url ? `< img src="${p.image_url}" class="post-img">` : '';

                d.innerHTML = `
                    <div class="user-tag">@${p.user_name || 'åŒ¿å'}</div>
                    <p class="post-content">${p.content}</p >
                    ${imgHtml}
                    <div class="actions">
                        <div class="action-item" onclick="like(${p.id}, ${p.likes || 0})">â¤ï¸ ${p.likes || 0}</div>
                        <div class="action-item">ğŸ’¬ ${cms ? cms.length : 0}</div>
                    </div>
                    <div class="comment-section">
                        <div id="cmt-list-${p.id}">${cms ? cms.map(c => `<div class="cmt-item"><b>${c.user_name}:</b> ${c.content}</div>`).join('') : ''}</div>
                        <input type="text" placeholder="å†™è¯„è®ºå¹¶å›è½¦..." onkeydown="if(event.keyCode==13) addComment(${p.id}, this)">
                    </div>
                `;
                list.appendChild(d);
            }
        }

        async function send() {
            const btn = document.getElementById('sendBtn');
            const name = document.getElementById('nickname').value || 'åŒ¿å';
            const val = document.getElementById('t').value;
            const file = document.getElementById('fileInput').files[0];
            let url = null;

            if (!val && !file) return;
            btn.innerText = "ä¸Šä¼ ä¸­...";
            btn.disabled = true;

            // 1. å…ˆä¼ å›¾ç‰‡
            if (file) {
                const fileName = Date.now() + '-' + file.name;
                const { data, error } = await client.storage.from('images').upload(fileName, file);
                if (error) {
                    alert("å›¾ç‰‡ä¸Šä¼ æŸœå­å¤±è´¥ï¼š" + error.message);
                } else {
                    const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(fileName);
                    url = publicUrl;
                }
            }

            // 2. å­˜å…¥æ•°æ®åº“
            await client.from('posts').insert([{ content: val, user_name: name, likes: 0, image_url: url }]);
            
            // 3. é‡ç½®å¹¶åˆ·æ–°
            btn.innerText = "å‘å¸ƒåŠ¨æ€";
            btn.disabled = false;
            document.getElementById('t').value = "";
            document.getElementById('fileInput').value = "";
            load();
        }

        async function like(id, curr) {
            await client.from('posts').update({ likes: curr + 1 }).eq('id', id);
            load();
        }

        async function addComment(postId, input) {
            const name = document.getElementById('nickname').value || 'åŒ¿å';
            if(!input.value) return;
            await client.from('comments').insert([{ post_id: postId, content: input.value, user_name: name }]);
            input.value = "";
            load();
        }

        load();
    </script>
</body>
</html>







